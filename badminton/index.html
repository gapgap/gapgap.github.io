<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>API Booking Scheduler</title>
  <style>
    :root { --gap: .8rem; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 1rem; margin: 0; background: #fff; color: #111; }
    .container { max-width: 860px; margin: 0 auto; padding: .5rem; }
    h1 { font-size: 1.4rem; margin: .5rem 0 1rem; }
    input, button, select { font-size: 1rem; padding: .6rem .7rem; margin: .25rem 0; width: 100%; box-sizing: border-box; }
    label { display: block; margin-top: .4rem; font-weight: 600; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    @media (max-width: 600px) { .row { grid-template-columns: 1fr; } }
    .panel { background: #fafafa; border: 1px solid #eee; border-radius: 12px; padding: 1rem; margin-top: 1rem; }
    .muted { color: #666; font-size: .95rem; font-weight: 400; }
    .highlight { font-weight: 700; }
    .controls { margin-top: .8rem; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--gap); }
    @media (max-width: 600px) { .controls { grid-template-columns: 1fr; } }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #f7f7f9; border: 1px solid #eee; padding: 1rem; margin-top: 1rem; white-space: pre-wrap; max-height: 40vh; overflow-y: auto; border-radius: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>API Scheduler</h1>

    <div class="row">
      <label>
        Mode (2 only)
        <select id="mode" onchange="onModeChange()">
          <option value="manual">Manual testing</option>
          <option value="friday">Friday booking (next week)</option>
        </select>
      </label>

      <label>
        Send option
        <select id="sendOption" onchange="onSendOptionChange()">
          <option value="now">Send now</option>
          <option value="schedule">Schedule</option>
        </select>
      </label>

      <label id="sendAtWrap" style="display:none">
        Send at (TH)
        <input type="datetime-local" id="sendAt" />
      </label>
    </div>

    <!-- Manual config -->
    <div id="manualPanel" class="panel">
      <div class="row">
        <label>
          Date (TH)
          <input type="date" id="manualDate" />
        </label>
        <label>
          Hour (TH) [17‚Äì21]
          <select id="manualHour">
            <option value="17">17:00</option>
            <option value="18">18:00</option>
            <option value="19">19:00</option>
            <option value="20">20:00</option>
            <option value="21">21:00</option>
          </select>
        </label>
      </div>
      <p class="muted">* End time = +1 hour, both converted to epoch (UTC) in the request.</p>
    </div>

    <!-- Token / Device ID -->
    <div class="row panel">
      <label>
        Token
        <input type="password" id="token" placeholder="Enter token" />
      </label>
      <label>
        Device ID
        <input type="text" id="device_id" placeholder="Enter device_id" />
      </label>
    </div>

    <!-- Friday booking info -->
    <div id="friPanel" class="panel" style="display:none">
      <div><span class="highlight">Target Friday (TH):</span> <span id="friDate">-</span></div>
      <div><span class="highlight">Will book slots (TH):</span> <span id="friSlots">-</span></div>
      <div class="muted">Both requests will be sent <b>concurrently</b>.</div>
    </div>

    <div class="row">
      <label>
        Payment Method
        <select id="paymentMethod">
          <option value="9">QR</option>
          <option value="1">Point</option>
        </select>
      </label>

      <label>
        Amount
        <input type="number" id="amount" value="2" min="1" />
      </label>
    </div>

    <div class="row">
      <label>
        Retry attempts
        <input type="number" id="retryCount" value="5" min="0" step="1" />
      </label>
      <label>
        Retry delay (fixed)
        <input type="text" value="500 ms" disabled />
      </label>
    </div>

    <div id="scheduleInfo" class="panel" style="display:none">
      <div><span class="highlight">Next send at:</span> <span id="nextSend">-</span></div>
      <div class="muted">Countdown: <span id="countdown">--:--:--</span></div>
    </div>

    <div class="controls">
      <button onclick="handleSubmit(true)">üîç Test Only (show request)</button>
      <button onclick="handleSubmit(false)">üöÄ Submit</button>
      <button onclick="clearLog()">üßπ Clear Log</button>
    </div>

    <div class="log" id="log"></div>
  </div>

  <script>
    const logDiv = document.getElementById('log');
    const manualPanel = document.getElementById('manualPanel');
    const friPanel = document.getElementById('friPanel');
    const sendAtWrap = document.getElementById('sendAtWrap');
    const sendAtInput = document.getElementById('sendAt');
    const nextSendEl = document.getElementById('nextSend');
    const countdownEl = document.getElementById('countdown');
    const friDateEl = document.getElementById('friDate');
    const friSlotsEl = document.getElementById('friSlots');
    const scheduleInfo = document.getElementById('scheduleInfo');

    let countdownTimer = null;

    function fmt(dt){const y=dt.getFullYear();const m=String(dt.getMonth()+1).padStart(2,'0');const d=String(dt.getDate()).padStart(2,'0');const hh=String(dt.getHours()).padStart(2,'0');const mm=String(dt.getMinutes()).padStart(2,'0');const ss=String(dt.getSeconds()).padStart(2,'0');return `${y}-${m}-${d} ${hh}:${mm}:${ss}`}
    function log(msg){logDiv.innerText = `[${fmt(new Date())}] ${msg}\n` + logDiv.innerText}
    function clearLog(){logDiv.innerText=''}

    function onModeChange(){
      const mode = document.getElementById('mode').value;
      manualPanel.style.display = mode==='manual' ? 'block' : 'none';
      friPanel.style.display = mode==='friday' ? 'block' : 'none';
      updateFridayInfo();
      saveSettings();
    }

    function onSendOptionChange(){
      const opt = document.getElementById('sendOption').value;
      sendAtWrap.style.display = opt==='schedule' ? 'block' : 'none';
      scheduleInfo.style.display = 'none';
      stopCountdown();
      saveSettings();
    }

    function stopCountdown(){ if(countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; } }
    function startCountdown(target){
      stopCountdown();
      const tick=()=>{const now=new Date();let diff=Math.max(0,target-now);const s=Math.floor(diff/1000);const hh=String(Math.floor(s/3600)).padStart(2,'0');const mm=String(Math.floor((s%3600)/60)).padStart(2,'0');const ss=String(s%60).padStart(2,'0');countdownEl.textContent=`${hh}:${mm}:${ss}`};
      tick(); countdownTimer=setInterval(tick,1000);
    }

    // --- Time helpers (TH -> epoch) ---
    function toEpochThailand(dateStr, hour){
      const [y,m,d]=dateStr.split('-').map(Number);
      const utc=new Date(Date.UTC(y,m-1,d,hour-7,0,0));
      return Math.floor(utc.getTime()/1000);
    }

    function getNextWeekFriday(){
      const now=new Date();
      const day=now.getDay(); // Sun=0..Sat=6
      const daysUntilThisFri=(5 - day + 7) % 7; // 0..6 to this week's Friday
      const thisFri=new Date(now.getFullYear(), now.getMonth(), now.getDate()+daysUntilThisFri, 0,0,0,0);
      const nextWeekFri=new Date(thisFri.getTime()+7*24*3600*1000); // Friday of next week 00:00
      return nextWeekFri;
    }

    function updateFridayInfo(){
      if(document.getElementById('mode').value!=='friday') return;
      const nextFri=getNextWeekFriday();
      const y=nextFri.getFullYear();const m=String(nextFri.getMonth()+1).padStart(2,'0');const d=String(nextFri.getDate()).padStart(2,'0');
      const dateStr=`${y}-${m}-${d}`;
      friDateEl.textContent = `${dateStr} (TH)`;
      friSlotsEl.textContent = `${dateStr} 19:00‚Äì20:00, ${dateStr} 20:00‚Äì21:00 (TH)`;
    }

    // --- Persistence ---
    function saveSettings(){
      const data={
        mode: document.getElementById('mode').value,
        sendOption: document.getElementById('sendOption').value,
        sendAt: sendAtInput.value,
        manualDate: document.getElementById('manualDate').value,
        manualHour: document.getElementById('manualHour').value,
        paymentMethod: document.getElementById('paymentMethod').value,
        amount: document.getElementById('amount').value,
        retryCount: document.getElementById('retryCount').value,
        token: document.getElementById('token').value,
        device_id: document.getElementById('device_id').value,
      };
      localStorage.setItem('apiScheduler_v2', JSON.stringify(data));
    }

    function loadSettings(){
      const saved=localStorage.getItem('apiScheduler_v2');
      if(saved){ try{ const d=JSON.parse(saved);
        document.getElementById('mode').value=d.mode||'manual';
        document.getElementById('sendOption').value=d.sendOption||'now';
        sendAtInput.value=d.sendAt||'';
        document.getElementById('manualDate').value=d.manualDate||'';
        document.getElementById('manualHour').value=d.manualHour||'17';
        document.getElementById('paymentMethod').value=d.paymentMethod||'9';
        document.getElementById('amount').value=d.amount||'2';
        document.getElementById('retryCount').value=d.retryCount||'5';
        document.getElementById('token').value=d.token||'';
        document.getElementById('device_id').value=d.device_id||'';
      }catch(e){ log('‚ö†Ô∏è Failed to load settings'); }}
      onModeChange(); onSendOptionChange(); updateFridayInfo();
    }

    // initial load
    loadSettings();
  </script>
</body>
</html>
