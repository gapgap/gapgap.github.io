<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>API Booking Scheduler</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 2rem; }
    input, button, select { font-size: 1rem; padding: 0.5rem; margin: 0.4rem 0; }
    label { display: block; margin-top: 0.6rem; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #f7f7f9; border: 1px solid #eee; padding: 1rem; margin-top: 1rem; white-space: pre-wrap; max-height: 320px; overflow-y: auto; }
    .controls { margin-top: 0.6rem; display: flex; gap: .5rem; flex-wrap: wrap; }
    .panel { background: #fafafa; border: 1px solid #eee; border-radius: 10px; padding: 1rem; margin-top: 1rem; }
    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: .8rem; }
    .muted { color: #666; font-size: .95rem; }
    .highlight { font-weight: 600; }
    .inline { display: inline-block; margin-right: 1rem; }
  </style>
</head>
<body>
  <h1>API Scheduler</h1>

  <div class="row">
    <label>
      Mode (only 2):
      <select id="mode" onchange="onModeChange()">
        <option value="manual">Manual testing</option>
        <option value="friday">Friday booking (next week)</option>
      </select>
    </label>

    <label>
      Send option:
      <select id="sendOption" onchange="onSendOptionChange()">
        <option value="now">Send now</option>
        <option value="schedule">Schedule</option>
      </select>
    </label>

    <label id="sendAtWrap" style="display:none">
      Send at (TH):
      <input type="datetime-local" id="sendAt" />
    </label>
  </div>

  <!-- Manual config -->
  <div id="manualPanel" class="panel">
    <div class="row">
      <label>
        Date (TH):
        <input type="date" id="manualDate" />
      </label>
      <label>
        Hour (TH) [17‚Äì21]:
        <select id="manualHour">
          <option value="17">17:00</option>
          <option value="18">18:00</option>
          <option value="19">19:00</option>
          <option value="20">20:00</option>
          <option value="21">21:00</option>
        </select>
      </label>
    </div>
    <p class="muted">* End time = +1 hour, both converted to epoch (UTC) in the request.</p>
  </div>

  <!-- Friday booking info -->
  <div id="friPanel" class="panel" style="display:none">
    <div><span class="highlight">Target Friday (TH):</span> <span id="friDate">-</span></div>
    <div><span class="highlight">Will book slots (TH):</span> <span id="friSlots">-</span></div>
  </div>

  <div class="row">
    <label>
      Payment Method:
      <select id="paymentMethod">
        <option value="9">QR</option>
        <option value="1">Point</option>
      </select>
    </label>

    <label>
      Amount:
      <input type="number" id="amount" value="2" min="1" />
    </label>
  </div>

  <div id="scheduleInfo" class="panel" style="display:none">
    <div><span class="highlight">Next send at:</span> <span id="nextSend">-</span></div>
    <div class="muted">Countdown: <span id="countdown">--:--:--</span></div>
  </div>

  <div class="controls">
    <button onclick="handleSubmit(true)">üîç Test Only (show request)</button>
    <button onclick="handleSubmit(false)">üöÄ Submit</button>
    <button onclick="clearLog()">üßπ Clear Log</button>
  </div>

  <div class="log" id="log"></div>

  <script>
    const logDiv = document.getElementById('log');
    const manualPanel = document.getElementById('manualPanel');
    const friPanel = document.getElementById('friPanel');
    const sendAtWrap = document.getElementById('sendAtWrap');
    const sendAtInput = document.getElementById('sendAt');
    const nextSendEl = document.getElementById('nextSend');
    const countdownEl = document.getElementById('countdown');
    const friDateEl = document.getElementById('friDate');
    const friSlotsEl = document.getElementById('friSlots');
    const scheduleInfo = document.getElementById('scheduleInfo');

    let countdownTimer = null;

    function fmt(dt){const y=dt.getFullYear();const m=String(dt.getMonth()+1).padStart(2,'0');const d=String(dt.getDate()).padStart(2,'0');const hh=String(dt.getHours()).padStart(2,'0');const mm=String(dt.getMinutes()).padStart(2,'0');const ss=String(dt.getSeconds()).padStart(2,'0');return `${y}-${m}-${d} ${hh}:${mm}:${ss}`}
    function log(msg){logDiv.innerText = `[${fmt(new Date())}] ${msg}\n` + logDiv.innerText}
    function clearLog(){logDiv.innerText=''}

    function onModeChange(){
      const mode = document.getElementById('mode').value;
      manualPanel.style.display = mode==='manual' ? 'block' : 'none';
      friPanel.style.display = mode==='friday' ? 'block' : 'none';
      updateFridayInfo();
      saveSession();
    }

    function onSendOptionChange(){
      const opt = document.getElementById('sendOption').value;
      sendAtWrap.style.display = opt==='schedule' ? 'block' : 'none';
      scheduleInfo.style.display = 'none';
      stopCountdown();
      saveSession();
    }

    function stopCountdown(){ if(countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; } }
    function startCountdown(target){
      stopCountdown();
      const tick=()=>{const now=new Date();let diff=Math.max(0,target-now);const s=Math.floor(diff/1000);const hh=String(Math.floor(s/3600)).padStart(2,'0');const mm=String(Math.floor((s%3600)/60)).padStart(2,'0');const ss=String(s%60).padStart(2,'0');countdownEl.textContent=`${hh}:${mm}:${ss}`};
      tick(); countdownTimer=setInterval(tick,1000);
    }

    // --- Time helpers (TH -> epoch) ---
    function toEpochThailand(dateStr, hour){
      const [y,m,d]=dateStr.split('-').map(Number);
      const utc=new Date(Date.UTC(y,m-1,d,hour-7,0,0));
      return Math.floor(utc.getTime()/1000);
    }

    function getNextWeekFriday(){
      const now=new Date();
      const day=now.getDay(); // Sun=0..Sat=6
      const daysUntilThisFri=(5 - day + 7) % 7; // 0..6 to this week's Friday
      const thisFri=new Date(now.getFullYear(), now.getMonth(), now.getDate()+daysUntilThisFri, 0,0,0,0);
      const nextWeekFri=new Date(thisFri.getTime()+7*24*3600*1000); // Friday of next week 00:00
      return nextWeekFri;
    }

    function updateFridayInfo(){
      if(document.getElementById('mode').value!=='friday') return;
      const nextFri=getNextWeekFriday();
      const y=nextFri.getFullYear();const m=String(nextFri.getMonth()+1).padStart(2,'0');const d=String(nextFri.getDate()).padStart(2,'0');
      const dateStr=`${y}-${m}-${d}`;
      friDateEl.textContent = `${dateStr} (TH)`;
      friSlotsEl.textContent = `${dateStr} 19:00‚Äì20:00, ${dateStr} 20:00‚Äì21:00 (TH)`;
    }

    // --- Request ---
    function sendPost(start,end,paymentMethod,amount,dryRun=false){
      const url='https://www.loga.app/privateapi/booking/create_appointment';
      const params=new URLSearchParams({
        token:'7ca52e96db35869acbde2a3462be6b75d52c84d6',
        device_id:'f95f4cfd-bc0d-41a3-ba83-896389e21c8b',
        card_id:'6364',
        slot_id:'12489',
        contact:'0818855930',
        remark:'',
        start:start,
        end:end,
        payment_method:paymentMethod,
        cuid:'',
        amount:amount,
        return_uri:'https://client.loga.app/card/6364/shop/approve-order'
      });
      if(dryRun){
        log(`üß™ [Dry Run] POST ${url}`);
        log(`Payload:\n${params.toString().replaceAll('&','\n')}`);
        return;
      }
      fetch(url,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:params})
        .then(r=>r.json()).then(d=>log(`‚úÖ Success: ${JSON.stringify(d)}`))
        .catch(e=>log(`‚ùå Failed: ${e}`));
    }

    function handleSubmit(dryRun=false){
      saveSession();
      const mode=document.getElementById('mode').value;
      const sendOpt=document.getElementById('sendOption').value;
      const paymentMethod=document.getElementById('paymentMethod').value;
      const amount=document.getElementById('amount').value;

      // compute start/end per mode
      if(mode==='manual'){
        const date=document.getElementById('manualDate').value;
        const hour=parseInt(document.getElementById('manualHour').value);
        if(!date||isNaN(hour)){ log('‚õî Please select both date and hour'); return; }
        const startUnix=toEpochThailand(date,hour);
        const endUnix=toEpochThailand(date,hour+1);

        if(sendOpt==='now'){
          sendPost(startUnix,endUnix,paymentMethod,amount,dryRun);
        }else{
          const sendAtStr=sendAtInput.value; if(!sendAtStr){ log('‚õî Please choose "Send at" time'); return; }
          const target=new Date(sendAtStr);
          if(target<=new Date()){ log('‚õî "Send at" must be in the future'); return; }
          nextSendEl.textContent=fmt(target)+' (TH)';
          scheduleInfo.style.display='block';
          startCountdown(target);
          const delay=target.getTime()-Date.now();
          log(`‚è≥ Scheduled manual request at ${fmt(target)} (TH)`);
          setTimeout(()=>{ log('üöÄ Sending manual request'); sendPost(startUnix,endUnix,paymentMethod,amount,dryRun); }, delay);
        }
        return;
      }

      // friday booking (next week) ‚Äì two requests for 19‚Äì20 and 20‚Äì21
      const nextFri=getNextWeekFriday();
      const y=nextFri.getFullYear();const m=String(nextFri.getMonth()+1).padStart(2,'0');const d=String(nextFri.getDate()).padStart(2,'0');
      const dateStr=`${y}-${m}-${d}`;
      const slot1={ start: toEpochThailand(dateStr,19), end: toEpochThailand(dateStr,20) };
      const slot2={ start: toEpochThailand(dateStr,20), end: toEpochThailand(dateStr,21) };

      if(sendOpt==='now'){
        log(`üöÄ Sending Friday booking (next week) now for ${dateStr} 19‚Äì21 (2 requests)`);
        sendPost(slot1.start,slot1.end,paymentMethod,amount,dryRun);
        sendPost(slot2.start,slot2.end,paymentMethod,amount,dryRun);
      }else{
        const sendAtStr=sendAtInput.value; if(!sendAtStr){ log('‚õî Please choose "Send at" time'); return; }
        const target=new Date(sendAtStr);
        if(target<=new Date()){ log('‚õî "Send at" must be in the future'); return; }
        nextSendEl.textContent=fmt(target)+' (TH)';
        scheduleInfo.style.display='block';
        startCountdown(target);
        const delay=target.getTime()-Date.now();
        log(`‚è≥ Scheduled Friday booking at ${fmt(target)} (TH) for ${dateStr} 19‚Äì21 (2 requests)`);
        setTimeout(()=>{
          log('üöÄ Sending 2 Friday booking requests');
          sendPost(slot1.start,slot1.end,paymentMethod,amount,dryRun);
          sendPost(slot2.start,slot2.end,paymentMethod,amount,dryRun);
        }, delay);
      }
    }

    // --- Persistence ---
    function saveSession(){
      const data={
        mode: document.getElementById('mode').value,
        sendOption: document.getElementById('sendOption').value,
        sendAt: sendAtInput.value,
        manualDate: document.getElementById('manualDate').value,
        manualHour: document.getElementById('manualHour').value,
        paymentMethod: document.getElementById('paymentMethod').value,
        amount: document.getElementById('amount').value,
      };
      sessionStorage.setItem('apiScheduler_v2', JSON.stringify(data));
    }

    function loadSession(){
      const saved=sessionStorage.getItem('apiScheduler_v2'); if(!saved) { onModeChange(); onSendOptionChange(); return; }
      try{
        const d=JSON.parse(saved);
        document.getElementById('mode').value=d.mode||'manual';
        document.getElementById('sendOption').value=d.sendOption||'now';
        sendAtInput.value=d.sendAt||'';
        document.getElementById('manualDate').value=d.manualDate||'';
        document.getElementById('manualHour').value=d.manualHour||'17';
        document.getElementById('paymentMethod').value=d.paymentMethod||'9';
        document.getElementById('amount').value=d.amount||'2';
      }catch(e){ log('‚ö†Ô∏è Failed to load session'); }
      onModeChange(); onSendOptionChange();
      updateFridayInfo();
    }

    loadSession();
  </script>
</body>
</html>
